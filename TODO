
INSTALLATION
============

  Installing NOKOGIRI:

     - ensure .ruby-version is 2.1.5
     - ensure .ruby-gemset is .courtfinder215
     - find location of xml2-config and xslt-config

          /usr/bin/xml2-config
          /usr/bin/xslt-config

    - gem install nokogiri -- --use-system-libraries --with-xml2-config=/usr/bin/xml2-config --with-xslt-config=/usr/bin/xslt-config



  Installing RMagick
    - set PKG_CONFIG_PATH environment variable to the directory that holds MagickCore.pc



OVERVIEW
========

  All models which which impact the data that needs to be pushed to gov.uk include the Courts::GovUkPushable concern.  
  This is responsible for creating a GovUkPushWorker sidekiq job with an action (:update, :create or :delete), and the 
  id of the court record.

  The GovUkPushWorker sidekiq job instantiates GovUkPusher to do the following:
    - find the court record
    - serialize it and creates an MD5 hash of the serialized json
    - if the MD5 hash does not match the MD5 hash on the court record (i.e. if the serialized data is 
      different from the last upload to gov.uk), then calls GovUKApiClient to push the data to gov.uk
      and update the court record with the new MD5 hash





Update court.details_updated_at when anything changes in:


** addresses - done
** contacts - done
** court_facilities - done
** court_types_courts
** courts - done
** emails
** opening_times
** postcode_courts
** remits



create workers/gov_uk_push_worker.rb

class GovUkPushWorker
  include Sidekiq::Worker

  def perform(court_id)
    CourtSerializer ......
  end
end

Then in the GovUkPushable concern, GovUkWorker.perform_async(court_id)


Serializer.

 - instantiate the court
 - serialize everything
 - validate against schema
 - create md5
 - compare with last md5
 - instantiate GovUkApiClient client and push
 - rsesponse, udpdate with url and md5


GovUkApiClient

  instantiates with court, and 

 - push to gov uk
 - check response
 - update court with new md5 if successful




 

TEst that when an address/contact etc is destroyed, a gov uk court update job is triggered



ENDPOINTS:

GDS:  https://courts-api.preview.alphagov.co.uk/court/[uuid]
MF:   https://safe-garden-8494.herokuapp.com/court/[UUID]



OUTSTANDING QUESTIONS
=====================

DX NUMBER
PARKING
email description




JSON VALIDATORS
===============


jschema - https://github.com/Soylent/jschema
validate works OK with their test data, but fails oin our schema with:
    
    JSchema::InvalidSchema: Specified schema version is not supported

********


ruby-jsonchema - https://github.com/Constellation/ruby-jsonchema
cannot install using bundler


*********

json-schema - https://github.com/ruby-json-schema/json-schema

works OK with test data, but using our schema, we get: 

Failure/Error: result = v.validate
     Errno::ENOENT:
       No such file or directory @ rb_sysopen - {
           "$schema": "http://json-schema.org/schema#",

works ok if I remove the $schema line from the schema.


**************








